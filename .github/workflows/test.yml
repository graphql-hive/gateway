name: Test

on:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_NO_WARNINGS: 1
  CI: true

jobs:
  unit:
    strategy:
      matrix:
        node-version:
          - 18
          - 20
          - 22
    name: Unit / Node v${{matrix.node-version}}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up env
        uses: the-guild-org/shared-config/setup@v1
        with:
          node-version: ${{matrix.node-version}}
      - name: Test
        run: yarn test

  unit-bun:
    name: Unit / Bun
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up env
        uses: the-guild-org/shared-config/setup@v1
        with:
          node-version: 22
      - name: Test
        run: yarn test:bun

  leaks:
    strategy:
      matrix:
        node-version:
          - 18
          - 20
          - 22
    name: Leaks / Node v${{matrix.node-version}}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up env
        uses: the-guild-org/shared-config/setup@v1
        with:
          node-version: ${{matrix.node-version}}
      - name: Run Tests
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: yarn test:leaks

  e2e:
    runs-on: ubuntu-latest
    name: E2E / SKIPPED TODO CHANGE BACK TO ACTUAL TESTS
    steps:
      - name: Skip
        run: exit 0

  examples:
    name: Examples
    needs: [e2e]
    uses: graphql-hive/gateway/.github/workflows/examples.yml@examples-call # TODO: change to main
    with:
      sha: ${{github.sha}}
    secrets:
      token: ${{secrets.BOT_GITHUB_TOKEN}}
