name: Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  dependencies:
    if: github.event_name == 'pull_request' && github.event.pull_request.title != 'Upcoming Release Changes'
    name: Dependencies
    uses: the-guild-org/shared-config/.github/workflows/changesets-dependencies.yml@v1
    with:
      node-version-file: .node-version
    secrets:
      githubToken: ${{ secrets.BOT_GITHUB_TOKEN }}

  # --- START CHECK --- #
  format:
    needs: [dependencies]
    name: Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up env
        uses: the-guild-org/shared-config/setup@v1
        with:
          node-version-file: .node-version
      - name: Check
        run: yarn check:format

  lint:
    needs: [format]
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up env
        uses: the-guild-org/shared-config/setup@v1
        with:
          node-version-file: .node-version
      - name: Check
        run: yarn check:lint

  types:
    needs: [lint]
    name: Types
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up env
        uses: the-guild-org/shared-config/setup@v1
        with:
          node-version-file: .node-version
      - name: Check
        run: yarn check:types

  build: # making sure build works so it doesn't fail on us during release
    needs: [types]
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up env
        uses: the-guild-org/shared-config/setup@v1
        with:
          node-version-file: .node-version
      - name: Check
        run: yarn build

  bundle: # making sure bundle works so it doesn't fail on us during release
    needs: [build]
    name: Bundle
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up env
        uses: the-guild-org/shared-config/setup@v1
        with:
          node-version-file: .node-version
      - name: Build
        run: yarn build
      - name: Check
        run: yarn bundle

  # --- START TEST --- #
  unit:
    strategy:
      fail-fast: false
      matrix:
        node-version:
          - 18
          - 20
          - 22
    name: Unit / Node v${{matrix.node-version}}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up env
        uses: the-guild-org/shared-config/setup@v1
        with:
          node-version: ${{matrix.node-version}}
      - name: Test
        run: yarn test

  leaks:
    needs: [unit]
    strategy:
      fail-fast: false
      matrix:
        node-version:
          - 18
          - 22
    name: Leaks / Node v${{matrix.node-version}}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up env
        uses: the-guild-org/shared-config/setup@v1
        with:
          node-version: ${{matrix.node-version}}
      - name: Test
        run: yarn test:leaks

  # TODO: various gateway runners
  e2e:
    needs: [build, bundle]
    runs-on: ${{ matrix.setup.os }}
    strategy:
      fail-fast: false
      matrix:
        setup:
          - os: ubuntu-latest
            gateway-runner: node
            node-version: 18
          - os: ubuntu-latest
            gateway-runner: node
            node-version: 20
          - os: ubuntu-latest
            gateway-runner: node
            node-version: 22
          - os: ubuntu-latest
            gateway-runner: docker
            node-version: 22
          - os: ubuntu-latest
            gateway-runner: bin
            node-version: 22
          - os: windows-latest
            gateway-runner: bin
            node-version: 22
          - os: macos-14 # MacOS Arm64
            gateway-runner: bin
            node-version: 22
          - os: macos-13 # MacOS x86_64
            gateway-runner: bin
            node-version: 22
    name: E2E / ${{matrix.setup.gateway-runner == 'node' && format('Node v{0}', matrix.setup.node-version) || ''}}${{matrix.setup.gateway-runner == 'docker' && 'Docker' || ''}}${{matrix.setup.gateway-runner == 'bin' && format('Binary on {0}', matrix.setup.os) || ''}}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - if: matrix.setup.gateway-runner == 'docker'
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - if: runner.os == 'Windows'
        name: Install Windows SDK
        uses: fbactions/setup-winsdk@v2
        with:
          # we want exact version because the signtool path depends on it in package-binary.ts
          winsdk-build-version: 18362
      - name: Set up env
        uses: the-guild-org/shared-config/setup@v1
        with:
          node-version: ${{matrix.setup.node-version}}
      - if: runner.os == 'Linux'
        name: Hash Docker Images
        id: hash-docker-images
        run: | # get all "image: '" occurrences in the e2e tests and hash them
          echo "result=$(grep -r -h "image: '" e2e | shasum | base64)" >> "$GITHUB_OUTPUT"
      - if: runner.os == 'Linux'
        name: Cache Docker Images
        uses: ScribeMD/docker-cache@0.5.0
        continue-on-error: true
        with:
          key: docker-images-${{ runner.os }}-${{ steps.hash-docker-images.outputs.result }}
      - name: Build
        run: yarn build
      - if: matrix.setup.gateway-runner == 'docker' || matrix.setup.gateway-runner == 'bin'
        name: Bundle
        env:
          E2E_GATEWAY_RUNNER: ${{matrix.setup.gateway-runner}}
        run: yarn workspace @graphql-hive/gateway bundle
      - if: matrix.setup.gateway-runner == 'docker'
        name: Bake
        uses: docker/bake-action@v5
        with:
          targets: e2e
          set: |
            *.cache-from=type=gha
            *.cache-to=type=gha,mode=max
          # we must load so that the e2e tests can use the cached image
          # also, in order for loading to work - we must define the platform above
          load: true
      - if: matrix.setup.gateway-runner == 'bin'
        name: Package binary
        run: yarn workspace @graphql-hive/gateway tsx scripts/package-binary
      - name: Test
        env:
          E2E_GATEWAY_RUNNER: ${{matrix.setup.gateway-runner}}
        run: yarn e2e:test

        # TODO: various gateway runners

  # --- START BENCH --- #
  bench:
    needs: [e2e]
    strategy:
      fail-fast: false
      matrix:
        node-version:
          - 18
          - 20
          - 22
    name: Benchmark / Node v${{matrix.node-version}}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up env
        uses: the-guild-org/shared-config/setup@v1
        with:
          node-version: ${{matrix.node-version}}
      - name: Hash Docker Images
        id: hash-docker-images
        run: | # get all "image: '" occurrences in the e2e tests and hash them
          echo "result=$(grep -r -h "image: '" e2e | shasum | base64)" >> "$GITHUB_OUTPUT"
      - name: Cache Docker Images
        uses: ScribeMD/docker-cache@0.5.0
        continue-on-error: true
        with:
          key: docker-images-${{ runner.os }}-${{ steps.hash-docker-images.outputs.result }}
      - name: Bench
        run: yarn e2e:bench

  # --- START RELEASE ---
  snapshot:
    needs: [build]
    if: github.event_name == 'pull_request'
    name: Snapshot
    uses: the-guild-org/shared-config/.github/workflows/release-snapshot.yml@v1
    with:
      node-version-file: .node-version
      npmTag: ${{ github.event.pull_request.title == 'Upcoming Release Changes' && 'rc' || 'alpha' }}
      restoreDeletedChangesets: ${{ github.event.pull_request.title == 'Upcoming Release Changes' && true || false }}
    secrets:
      githubToken: ${{ secrets.BOT_GITHUB_TOKEN }}
      npmToken: ${{ secrets.NPM_TOKEN }}
  stable:
    needs: [build]
    if: github.ref == 'refs/heads/main'
    name: Stable
    uses: the-guild-org/shared-config/.github/workflows/release-stable.yml@v1
    with:
      node-version-file: .node-version
      releaseScript: changeset publish
      versionScript: changeset version
    secrets:
      githubToken: ${{ secrets.BOT_GITHUB_TOKEN }}
      npmToken: ${{ secrets.NPM_TOKEN }}
  ghcr:
    needs: [build, bundle, stable, snapshot]
    name: GitHub Container Registry
    runs-on: ubuntu-latest
    if: always() && (
      contains(needs.stable.outputs.publishedPackages, '@graphql-hive/gateway') ||
      contains(needs.snapshot.outputs.publishedPackages, '@graphql-hive/gateway')
      )
    steps:
      - name: Version
        uses: actions/github-script@v7
        id: ver-gateway
        with:
          script: |
            const publishedPackages = ${{ needs.stable.outputs.publishedPackages || needs.snapshot.outputs.publishedPackages }};
            const gateway = publishedPackages.find((p) => p.name === '@graphql-hive/gateway');
            if (!gateway) {
              return core.setFailed('@graphql-hive/gateway was not published!');
            }
            const { version } = gateway;
            let r;
            if (context.eventName === 'pull_request') {
              r = { version, tags: version };
            } else {
              const [major, minor] = version.split('.');
              if (!major || !minor) {
                return core.setFailed(`Unknown major or minor in version "${version}"!`);
              }
              r = { version, tags: `latest,${major},${major}.${minor},${version}` };
            }
            console.log(r);
            return r;
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up env
        uses: the-guild-org/shared-config/setup@v1
        with:
          node-version-file: .node-version
      - name: Build
        run: yarn build
      - name: Bundle
        run: yarn workspace @graphql-hive/gateway bundle
      - name: Inject version
        run: yarn workspace @graphql-hive/gateway tsx scripts/inject-version ${{ fromJSON(steps.ver-gateway.outputs.result).version }}
      - name: Bake and Push
        uses: docker/bake-action@v5
        env:
          GATEWAY_TAGS: ${{ fromJSON(steps.ver-gateway.outputs.result).tags }}
        with:
          targets: gateway
          set: |
            *.cache-from=type=gha
            *.cache-to=type=gha,mode=max
          push: true
      - if: github.event_name == 'pull_request'
        name: Comment on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          # match pr comment like with changesets-snapshot-action from the guild's shared-config
          GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
          header: snapshot-release-docker-image
          message: |
            ### 🚀 Snapshot Release (Docker Image)

            The latest changes of this PR are available as image on GitHub Container Registry (based on the declared `changesets`):
            ```
            ghcr.io/graphql-hive/gateway:${{ fromJSON(steps.ver-gateway.outputs.result).version }}
            ```
  bin:
    needs: [build, bundle, stable, snapshot]
    name: Binary built on ${{ matrix.os }}
    if: always() && (
      contains(needs.stable.outputs.publishedPackages, '@graphql-hive/gateway') ||
      contains(needs.snapshot.outputs.publishedPackages, '@graphql-hive/gateway')
      )
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-13, macos-14, windows-latest]
    steps:
      - name: Version
        uses: actions/github-script@v7
        id: ver-gateway
        with:
          result-encoding: string
          script: |
            const publishedPackages = ${{ needs.stable.outputs.publishedPackages || needs.snapshot.outputs.publishedPackages }};
            const gateway = publishedPackages.find((p) => p.name === '@graphql-hive/gateway');
            if (!gateway) {
              return core.setFailed('@graphql-hive/gateway was not published!');
            }
            const { version } = gateway;
            console.log({ version });
            return version;
      - name: Checkout
        uses: actions/checkout@v4
      - if: runner.os == 'Windows'
        name: Install Windows SDK
        uses: fbactions/setup-winsdk@v2
        with:
          # we want exact version because the signtool path depends on it in package-binary.ts
          winsdk-build-version: 18362
      - name: Set up env
        uses: the-guild-org/shared-config/setup@v1
        with:
          node-version-file: .node-version
      - name: Build
        run: yarn build
      - name: Bundle
        run: yarn workspace @graphql-hive/gateway bundle
      - name: Inject version
        run: yarn workspace @graphql-hive/gateway tsx scripts/inject-version "${{ steps.ver-gateway.outputs.result }}"
      - name: Package binary
        run: yarn workspace @graphql-hive/gateway tsx scripts/package-binary
      - name: Set binary info
        id: binary
        run: |
          echo "name=hive-gateway-${{ runner.os }}-${{ runner.arch }}${{ runner.os == 'Windows' && '.exe' || ''}}" >> ${{ runner.os == 'Windows' && '$ENV:GITHUB_OUTPUT' || '$GITHUB_OUTPUT' }}
          echo "path=packages/gateway/hive-gateway${{ runner.os == 'Windows' && '.exe' || '' }}" >> ${{ runner.os == 'Windows' && '$ENV:GITHUB_OUTPUT' || '$GITHUB_OUTPUT' }}
      - if: github.ref == 'refs/heads/main'
        name: Compress binary
        id: compressed-binary
        run: |
          gzip -9 ${{ steps.binary.outputs.path }}
          echo "name=${{ steps.binary.outputs.name }}.gz" >> ${{ runner.os == 'Windows' && '$ENV:GITHUB_OUTPUT' || '$GITHUB_OUTPUT' }}
          echo "path=${{ steps.binary.outputs.path }}.gz" >> ${{ runner.os == 'Windows' && '$ENV:GITHUB_OUTPUT' || '$GITHUB_OUTPUT' }}
      - if: github.ref == 'refs/heads/main'
        name: Upload release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.BOT_GITHUB_TOKEN }}
          tag: hive-gateway@${{ steps.ver-gateway.outputs.result }}
          release_name: hive-gateway@${{ steps.ver-gateway.outputs.result }}
          asset_name: ${{ steps.compressed-binary.outputs.name }}
          file: ${{ steps.compressed-binary.outputs.path }}
          body: Pre-built binaries of the Hive Gateway for the **@graphql-hive/gateway@${{ steps.ver-gateway.outputs.result }}** release.
          overwrite: true
      - if: github.event_name == 'pull_request'
        name: Upload artifact
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.binary.outputs.name }}
          path: ${{ steps.binary.outputs.path }}
      - if: github.event_name == 'pull_request'
        name: Comment on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          # match pr comment like with changesets-snapshot-action from the guild's shared-config
          GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
          header: snapshot-release-binary-${{ runner.os }}-${{ runner.arch }}
          message: |
            ### 🚀 Snapshot Release (Binary for `${{ runner.os }}-${{ runner.arch }}`)

            The latest changes of this PR are available for download (based on the declared `changesets`).

            [![Download](https://custom-icon-badges.demolab.com/badge/-Download-blue?style=for-the-badge&logo=download&logoColor=white "Download")](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/${{ steps.upload.outputs.artifact-id }})
